{
    # Disable admin interface
    admin off
    # Enable debug logging
    debug
}

# Backend API
api.localhost {
    tls internal # Use Caddy's internal CA for local certs
    reverse_proxy nginx:80 {
        header_up Host {host} # Preserve original Host header
        header_up X-Forwarded-Proto https
    }
}


# QGIS Server
qgis.localhost {
    tls internal

    # Forward authentication to Django
    route {
        # Authenticate all requests via Django
        forward_auth nginx:80 {
            uri /api/auth/qgis-auth/
            copy_headers Authorization
        }

        # Proxy to QGIS Server
        reverse_proxy qgis-server:80 {
            header_up Host {host}
            header_up X-Forwarded-Proto https
        }
    }
}

# Frontend
app.localhost {
    tls internal # Use Caddy's internal CA for local certs
    reverse_proxy frontend:3000 {
        header_up Host {host} # Preserve original Host header
        header_up X-Forwarded-Proto {scheme}
    }
}

# WebDAV File Access
files.localhost {
    tls internal # Use Caddy's internal CA for local certs

    # Forward authentication to Django
    route {
        # Authenticate all requests via Django
        forward_auth nginx:80 {
            uri /api/auth/webdav-auth/
            copy_headers Authorization
        }

        # Serve files via WebDAV
        webdav {
            root /media
            prefix /
        }
    }
}